name: MacOS CI

on: [workflow_dispatch, pull_request]

jobs:
  build:
    name: Building with SOFA ${{ matrix.sofa_branch }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [macos-10.15]
        sofa_branch: [master, v21.06]
    env:
      SOFA_ROOT: /opt/sofa
      SYSTEM: MacOS

    steps:
      - name: Checkout source code
        uses: actions/checkout@v2

      - name: Set up Python 3.7
        uses: actions/setup-python@v2
        with:
          python-version: '3.7'

      - name: Install requirements
        run: |
          brew install ccache ninja boost eigen pybind11
          python3 -m pip install numpy scipy

      - name: Download and install the latest SOFA ${{ matrix.sofa_branch }} binaries
        shell: bash
        run: |
          mkdir -p /tmp/sofa_zip
          mkdir -p /tmp/sofa_binaries
          curl --output /tmp/sofa_zip/${SYSTEM}.zip -L \
            https://ci.inria.fr/sofa-ci-dev/job/nightly-generate-binaries/CI_BRANCH=${{ matrix.sofa_branch }},CI_SCOPE=minimal/lastSuccessfulBuild/artifact/${SYSTEM}/*zip*/${SYSTEM}.zip
          unzip -qq /tmp/sofa_zip/${SYSTEM}.zip -d /tmp/sofa_zip
          unzip -qq /tmp/sofa_zip/${SYSTEM}/SOFA_*.zip -d /tmp/sofa_binaries
          sudo mv /tmp/sofa_binaries/SOFA_* ${SOFA_ROOT}
          sudo ls -la ${SOFA_ROOT}
          rm -rf /tmp/sofa_*

      - name: ccache cache files
        uses: actions/cache@v2
        with:
          path: .ccache
          key: ccache_${{ matrix.sofa_branch }}_${{ matrix.os }}_${{ hashFiles('**/lockfiles') }}

      - name: Build
        env:
          CCACHE_COMPRESS: true
          CCACHE_COMPRESSLEVEL: 6
          CCACHE_MAXSIZE: "500M"
        run: |
          export CCACHE_BASEDIR=$GITHUB_WORKSPACE
          export CCACHE_DIR=$GITHUB_WORKSPACE/.ccache
          ccache -z
          cmake \
            -GNinja \
            -DCMAKE_C_COMPILER_LAUNCHER=ccache \
            -DCMAKE_CXX_COMPILER_LAUNCHER=ccache \
            -DCMAKE_PREFIX_PATH=$SOFA_ROOT/lib/cmake \
            -DCMAKE_BUILD_TYPE=Release \
            .
          ninja install
          echo ${CCACHE_BASEDIR}
          ccache -s

      - name: Create artifact
        uses: actions/upload-artifact@v2
        with:
          name: SofaPython3_${{ matrix.sofa_branch }}_${{ matrix.os }}
          path: install

  tests:
    name: Testing with SOFA ${{ matrix.sofa_branch }}
    needs: [build]
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [macos-10.15]
        sofa_branch: [master, v21.06]
    env:
      SOFA_ROOT: /opt/sofa
      SYSTEM: MacOS

    steps:
      - name: Set up Python 3.7
        uses: actions/setup-python@v2
        with:
          python-version: '3.7'

      - name: Install requirements
        run: |
          brew install boost
          python3 -m pip install numpy scipy

      - name: Download and install the latest SOFA ${{ matrix.sofa_branch }} binaries
        shell: bash
        run: |
          mkdir -p /tmp/sofa_zip
          mkdir -p /tmp/sofa_binaries
          curl --output /tmp/sofa_zip/${SYSTEM}.zip -L \
            https://ci.inria.fr/sofa-ci-dev/job/nightly-generate-binaries/CI_BRANCH=${{ matrix.sofa_branch }},CI_SCOPE=minimal/lastSuccessfulBuild/artifact/${SYSTEM}/*zip*/${SYSTEM}.zip
          unzip -qq /tmp/sofa_zip/${SYSTEM}.zip -d /tmp/sofa_zip
          unzip -qq /tmp/sofa_zip/${SYSTEM}/SOFA_*.zip -d /tmp/sofa_binaries
          sudo mv /tmp/sofa_binaries/SOFA_* ${SOFA_ROOT}
          sudo ls -la ${SOFA_ROOT}
          rm -rf /tmp/sofa_*

      - name: Install SP3
        uses: actions/download-artifact@v2
        with:
          name: SofaPython3_${{ matrix.sofa_branch }}_${{ matrix.os }}
          path: SofaPython3

      - name: Binding.Sofa.Tests
        if: ${{ always() }}
        run: |
          export DYLD_LIBRARY_PATH=$GITHUB_WORKSPACE/SofaPython3/lib:$SOFA_ROOT/lib
          export PYTHONPATH=$GITHUB_WORKSPACE/SofaPython3/lib/python3/site-packages
          chmod +x SofaPython3/bin/Bindings.Sofa.Tests
          ./SofaPython3/bin/Bindings.Sofa.Tests
      - name: Bindings.SofaRuntime.Tests
        if: ${{ always() }}
        run: |
          export DYLD_LIBRARY_PATH=$GITHUB_WORKSPACE/SofaPython3/lib:$SOFA_ROOT/lib
          export PYTHONPATH=$GITHUB_WORKSPACE/SofaPython3/lib/python3/site-packages
          chmod +x SofaPython3/bin/Bindings.SofaRuntime.Tests
          ./SofaPython3/bin/Bindings.SofaRuntime.Tests
      - name: Bindings.SofaTypes.Tests
        if: ${{ always() }}
        run: |
          export DYLD_LIBRARY_PATH=$GITHUB_WORKSPACE/SofaPython3/lib:$SOFA_ROOT/lib
          export PYTHONPATH=$GITHUB_WORKSPACE/SofaPython3/lib/python3/site-packages
          chmod +x SofaPython3/bin/Bindings.SofaTypes.Tests
          ./SofaPython3/bin/Bindings.SofaTypes.Tests
      - name: Bindings.Modules.Tests
        if: ${{ always() }}
        run: |
          export DYLD_LIBRARY_PATH=$GITHUB_WORKSPACE/SofaPython3/lib:$SOFA_ROOT/lib
          export PYTHONPATH=$GITHUB_WORKSPACE/SofaPython3/lib/python3/site-packages
          chmod +x SofaPython3/bin/Bindings.Modules.Tests
          ./SofaPython3/bin/Bindings.Modules.Tests
